<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­å…«å­—ç´€éŒ„-å…¨åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <style>
        .bg-wood { background-color: #f0fdf4; border-color: #bbf7d0; } 
        .bg-fire { background-color: #fef2f2; border-color: #fecaca; } 
        .bg-earth { background-color: #fffbeb; border-color: #fef3c7; } 
        .bg-metal { background-color: #f8fafc; border-color: #e2e8f0; } 
        .bg-water { background-color: #eff6ff; border-color: #bfdbfe; } 
    </style>
</head>
<body class="bg-slate-50 min-h-screen py-6 px-4 font-sans text-slate-900">

    <div class="max-w-xl mx-auto space-y-6">
        <div class="bg-white rounded-3xl shadow-xl p-6 border border-slate-200">
            <header class="text-center mb-6 border-b pb-4">
                <h1 class="text-2xl font-black text-indigo-600">å…«å­—å‘½ä¾‹æ”¶è—</h1>
                <div id="status" class="text-[10px] text-amber-500 mt-1 font-bold">â— ç³»çµ±è¼‰å…¥ä¸­...</div>
            </header>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-1"><label class="text-xs font-bold text-slate-500">å§“å</label><input type="text" id="name" placeholder="è¼¸å…¥å§“å" class="w-full mt-1 border rounded-xl p-3 bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500"></div>
                    <div class="col-span-1"><label class="text-xs font-bold text-slate-500">æ€§åˆ¥</label><select id="gender" class="w-full mt-1 border rounded-xl p-3 bg-slate-50 outline-none"><option value="ä¹¾é€ ">ç”· (ä¹¾)</option><option value="å¤é€ ">å¥³ (å¤)</option></select></div>
                    <div class="col-span-2"><label class="text-xs font-bold text-slate-500">å‡ºç”Ÿæ™‚é–“ (é™½æ›†)</label><div class="flex gap-2"><input type="date" id="date" class="w-full border rounded-xl p-3 bg-slate-50"><input type="time" id="time" value="12:00" class="w-full border rounded-xl p-3 bg-slate-50"></div></div>
                </div>

                <button id="mainBtn" onclick="runBazi()" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg hover:bg-indigo-700 active:scale-95 transition">ç«‹å³æ’ç›¤èˆ‡åˆ†æèƒ½é‡</button>

                <div class="bg-slate-900 rounded-2xl p-4 shadow-inner">
                    <div class="grid grid-cols-4 gap-2 text-center text-white">
                        <div class="space-y-1"><span id="hS" class="text-[11px] font-bold text-amber-400 block h-4">--</span><div id="hP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg border border-slate-700">--</div><span class="text-[10px] text-slate-500 block">æ™‚æŸ±</span></div>
                        <div class="space-y-1"><span class="text-[11px] font-bold text-rose-400 block h-4">æ—¥ä¸»</span><div id="dP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg border-2 border-rose-500/50">--</div><span class="text-[10px] text-slate-500 block">æ—¥æŸ±</span></div>
                        <div class="space-y-1"><span id="mS" class="text-[11px] font-bold text-amber-400 block h-4">--</span><div id="mP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg border border-slate-700">--</div><span class="text-[10px] text-slate-500 block">æœˆæŸ±</span></div>
                        <div class="space-y-1"><span id="yS" class="text-[11px] font-bold text-amber-400 block h-4">--</span><div id="yP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg border border-slate-700">--</div><span class="text-[10px] text-slate-500 block">å¹´æŸ±</span></div>
                    </div>
                </div>

                <div id="elementArea" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <h3 class="text-xs font-bold text-slate-500 mb-3">äº”è¡Œèƒ½é‡ä½”æ¯” (å¤©å¹²åœ°æ”¯)</h3>
                    <div id="elementBars" class="space-y-2"></div>
                </div>

                <button onclick="saveRecord()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:bg-emerald-700 transition">ğŸ’¾ å„²å­˜å®Œæ•´ç´€éŒ„</button>
            </div>
        </div>
        <div id="historyList" class="space-y-3 pb-10"></div>
    </div>

    <script>
        const ELEMENTS = { 'æœ¨': 'bg-emerald-500', 'ç«': 'bg-rose-500', 'åœŸ': 'bg-amber-600', 'é‡‘': 'bg-slate-400', 'æ°´': 'bg-blue-500' };
        const FIVE_ELEMENTS = { 'ç”²':'æœ¨','ä¹™':'æœ¨','å¯…':'æœ¨','å¯':'æœ¨','ä¸™':'ç«','ä¸':'ç«','å·³':'ç«','åˆ':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','è¾°':'åœŸ','æˆŒ':'åœŸ','ä¸‘':'åœŸ','æœª':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','ç”³':'é‡‘','é…‰':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´','äº¥':'æ°´','å­':'æ°´' };
        const SHI_SHEN_MAP = { 'æ¯”è‚©':['ç”²ç”²','ä¹™ä¹™','ä¸™ä¸™','ä¸ä¸','æˆŠæˆŠ','å·±å·±','åºšåºš','è¾›è¾›','å£¬å£¬','ç™¸ç™¸'], 'åŠ«è²¡':['ç”²ä¹™','ä¹™ç”²','ä¸™ä¸','ä¸ä¸™','æˆŠå·±','å·±æˆŠ','åºšè¾›','è¾›åºš','å£¬ç™¸','ç™¸å£¬'], 'é£Ÿç¥':['ç”²ä¸™','ä¹™ä¸','ä¸™æˆŠ','ä¸å·±','æˆŠåºš','å·±è¾›','åºšå£¬','è¾›ç™¸','å£¬ç”²','ç™¸ä¹™'], 'å‚·å®˜':['ç”²ä¸','ä¹™ä¸™','ä¸™å·±','ä¸æˆŠ','æˆŠè¾›','å·±åºš','åºšç™¸','è¾›å£¬','å£¬ä¹™','ç™¸ç”²'], 'åè²¡':['ç”²æˆŠ','ä¹™å·±','ä¸™åºš','ä¸è¾›','æˆŠå£¬','å·±ç™¸','åºšç”²','è¾›ä¹™','å£¬ä¸™','ç™¸ä¸'], 'æ­£è²¡':['ç”²å·±','ä¹™æˆŠ','ä¸™è¾›','ä¸åºš','æˆŠç™¸','å·±å£¬','åºšä¹™','è¾›ç”²','å£¬ä¸','ç™¸ä¸™'], 'ä¸ƒæ®º':['ç”²åºš','ä¹™è¾›','ä¸™å£¬','ä¸ç™¸','æˆŠç”²','å·±ä¹™','åºšä¸™','è¾›ä¸','å£¬æˆŠ','ç™¸å·±'], 'æ­£å®˜':['ç”²è¾›','ä¹™åºš','ä¸™ç™¸','ä¸å£¬','æˆŠä¹™','å·±ç”²','åºšä¸','è¾›ä¸™','å£¬å·±','ç™¸å¸«'], 'åå°':['ç”²å£¬','ä¹™ç™¸','ä¸™ç”²','ä¸ä¹™','æˆŠä¸™','å·±ä¸','åºšæˆŠ','è¾›å·±','å£¬åºš','ç™¸è¾›'], 'æ­£å°':['ç”²ç™¸','ä¹™å£¬','ä¸™ä¹™','ä¸ç”²','æˆŠä¸','å·±ä¸™','åºšå·±','è¾›åºš','å£¬è¾›','ç™¸åºš'] };

        let cur = null;

        function checkInit() {
            if (typeof Solar !== 'undefined') {
                document.getElementById('status').innerText = "â— ç³»çµ±å°±ç·’";
                document.getElementById('status').classList.replace('text-amber-500', 'text-emerald-500');
                return true;
            }
            return false;
        }
        setInterval(checkInit, 1000);

        function getSS(dG, tG) {
            const pair = dG + tG;
            for (let key in SHI_SHEN_MAP) if (SHI_SHEN_MAP[key].includes(pair)) return key;
            return "--";
        }

        function runBazi() {
            if (!checkInit()) return alert("ç³»çµ±è¼‰å…¥ä¸­...");
            const dV = document.getElementById('date').value;
            if (!dV) return alert("è«‹é¸ç”Ÿæ—¥");
            const [y, m, d] = dV.split('-').map(Number);
            const [hh, mm] = document.getElementById('time').value.split(':').map(Number);
            
            const s = Solar.fromYmdHms(y, m, d, hh, mm, 0);
            const l = s.getLunar(), b = l.getEightChar();
            const dG = b.getDayGan();

            // é¡¯ç¤ºç›¤é¢
            document.getElementById('yP').innerText = b.getYear(); document.getElementById('mP').innerText = b.getMonth();
            document.getElementById('dP').innerText = b.getDay(); document.getElementById('hP').innerText = b.getTime();
            document.getElementById('yS').innerText = getSS(dG, b.getYearGan());
            document.getElementById('mS').innerText = getSS(dG, b.getMonthGan());
            document.getElementById('hS').innerText = getSS(dG, b.getTimeGan());

            // äº”è¡Œåˆ†æ
            const allChars = (b.getYear()+b.getMonth()+b.getDay()+b.getTime()).split('');
            let counts = { 'æœ¨':0, 'ç«':0, 'åœŸ':0, 'é‡‘':0, 'æ°´':0 };
            allChars.forEach(char => { if(FIVE_ELEMENTS[char]) counts[FIVE_ELEMENTS[char]]++; });
            
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            let barHtml = '';
            let energyText = '';
            for(let key in counts) {
                const percent = Math.round((counts[key]/total)*100);
                barHtml += `<div class="flex items-center gap-2"><span class="text-[10px] w-4 font-bold">${key}</span><div class="flex-1 bg-white rounded-full h-2 overflow-hidden border"><div class="${ELEMENTS[key]} h-full" style="width:${percent}%"></div></div><span class="text-[10px] w-8 text-right">${percent}%</span></div>`;
                energyText += `${key}${percent}% `;
            }
            document.getElementById('elementBars').innerHTML = barHtml;
            document.getElementById('elementArea').classList.remove('hidden');

            cur = { 
                p: `${b.getTime()} ${b.getDay()} ${b.getMonth()} ${b.getYear()}`,
                s: `${getSS(dG, b.getTimeGan())} | æ—¥ä¸» | ${getSS(dG, b.getMonthGan())} | ${getSS(dG, b.getYearGan())}`,
                e: energyText.trim(),
                dm: FIVE_ELEMENTS[dG]
            };
        }

        function saveRecord() {
            if (!cur) return alert("è«‹å…ˆé»æ“Šæ’ç›¤æŒ‰éˆ•");
            const name = document.getElementById('name').value || "æœªå";
            const gen = document.getElementById('gender').value;
            const styleClass = { 'æœ¨':'bg-wood', 'ç«':'bg-fire', 'åœŸ':'bg-earth', 'é‡‘':'bg-metal', 'æ°´':'bg-water' }[cur.dm];
            
            // çµ„åˆå®Œæ•´ç´€éŒ„æ–‡å­—
            const text = `ã€å‘½ä¾‹ç´€éŒ„ã€‘\nå§“åï¼š${name} (${gen})\nå…«å­—ï¼š${cur.p}\nä¸»æ˜Ÿï¼š${cur.s}\nèƒ½é‡ï¼š${cur.e}\n--------------------\næ—¥æœŸï¼š${document.getElementById('date').value}`;
            
            const h = JSON.parse(localStorage.getItem('bazi_v9') || '[]');
            h.unshift({ id: Date.now(), text, name, style: styleClass });
            localStorage.setItem('bazi_v9', JSON.stringify(h));
            render();
            alert("å·²æˆåŠŸå„²å­˜åˆ°æ¸…å–®ï¼");
        }

        function render() {
            const h = JSON.parse(localStorage.getItem('bazi_v9') || '[]');
            document.getElementById('historyList').innerHTML = h.map(i => `
                <div class="${i.style || 'bg-white'} p-4 rounded-2xl shadow-sm border mb-3 transition-all">
                    <div class="flex justify-between text-xs font-bold mb-2">
                        <span class="text-slate-700">${i.name} çš„æ”¶è—</span>
                        <button onclick="del(${i.id})" class="text-slate-400 hover:text-red-500">åˆªé™¤</button>
                    </div>
                    <pre class="text-[11px] font-mono bg-white/60 p-3 rounded-lg border border-black/5 overflow-x-auto leading-relaxed text-slate-600">${i.text}</pre>
                    <button onclick="copyToClip(\`${i.text.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, this)" class="w-full mt-3 py-3 bg-white/90 text-
