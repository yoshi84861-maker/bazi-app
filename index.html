<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—ç´€éŒ„-çµ‚æ¥µä¸å¡æ­»ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-wood { background-color: #f0fdf4; border-color: #bbf7d0; } 
        .bg-fire { background-color: #fef2f2; border-color: #fecaca; } 
        .bg-earth { background-color: #fffbeb; border-color: #fef3c7; } 
        .bg-metal { background-color: #f8fafc; border-color: #e2e8f0; } 
        .bg-water { background-color: #eff6ff; border-color: #bfdbfe; } 
        .bazi-box { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen py-6 px-4 font-sans text-slate-900">

    <div class="max-w-xl mx-auto space-y-6">
        <div class="bg-white rounded-3xl shadow-xl p-6 border border-slate-200">
            <header class="text-center mb-6 border-b pb-4">
                <h1 class="text-2xl font-black text-indigo-600">å…«å­—å‘½ä¾‹æ”¶è—</h1>
                <p class="text-[10px] text-emerald-600 font-bold mt-1">â— é›¢ç·šé‹ç®—æ¨¡çµ„å·²å…§ç½®</p>
            </header>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-1"><label class="text-xs font-bold text-slate-500">å§“å</label><input type="text" id="name" placeholder="è¼¸å…¥å§“å" class="w-full mt-1 border rounded-xl p-3 bg-slate-50 outline-none"></div>
                    <div class="col-span-1"><label class="text-xs font-bold text-slate-500">æ€§åˆ¥</label><select id="gender" class="w-full mt-1 border rounded-xl p-3 bg-slate-50"><option value="ä¹¾é€ ">ç”· (ä¹¾)</option><option value="å¤é€ ">å¥³ (å¤)</option></select></div>
                    <div class="col-span-2"><label class="text-xs font-bold text-slate-500">å‡ºç”Ÿæ™‚é–“ (é™½æ›†)</label><div class="flex gap-2"><input type="date" id="date" class="w-full border rounded-xl p-3 bg-slate-50"><input type="time" id="time" value="12:00" class="w-full border rounded-xl p-3 bg-slate-50"></div></div>
                </div>

                <button onclick="calculateBazi()" class="w-full py-4 bg-indigo-600 text-white font-black rounded-2xl shadow-lg active:scale-95 transition">ç«‹å³æ’ç›¤èˆ‡åˆ†æ</button>

                <div class="bg-slate-900 rounded-2xl p-4 bazi-box">
                    <div class="grid grid-cols-4 gap-2 text-center text-white">
                        <div class="space-y-1"><span id="hS" class="text-[11px] font-bold text-amber-400 block h-4">--</span><div id="hP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg">--</div><span class="text-[10px] text-slate-500">æ™‚æŸ±</span></div>
                        <div class="space-y-1"><span class="text-[11px] font-bold text-rose-400 block h-4">æ—¥ä¸»</span><div id="dP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg border-2 border-rose-500/50">--</div><span class="text-[10px] text-slate-500">æ—¥æŸ±</span></div>
                        <div class="space-y-1"><span id="mS" class="text-[11px] font-bold text-amber-400 block h-4">--</span><div id="mP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg">--</div><span class="text-[10px] text-slate-500">æœˆæŸ±</span></div>
                        <div class="space-y-1"><span id="yS" class="text-[11px] font-bold text-amber-400 block h-4">--</span><div id="yP" class="bg-slate-800 py-3 rounded-lg font-bold text-lg">--</div><span class="text-[10px] text-slate-500">å¹´æŸ±</span></div>
                    </div>
                </div>

                <div id="elementArea" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200 animate-fade-in">
                    <div id="elementBars" class="space-y-2"></div>
                </div>

                <button onclick="saveToHistory()" class="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl shadow-lg">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
            </div>
        </div>
        <div id="historyList" class="space-y-3 pb-10"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>

    <script>
        const FIVE_ELEMENTS = { 'ç”²':'æœ¨','ä¹™':'æœ¨','å¯…':'æœ¨','å¯':'æœ¨','ä¸™':'ç«','ä¸':'ç«','å·³':'ç«','åˆ':'ç«','æˆŠ':'åœŸ','å·±':'åœŸ','è¾°':'åœŸ','æˆŒ':'åœŸ','ä¸‘':'åœŸ','æœª':'åœŸ','åºš':'é‡‘','è¾›':'é‡‘','ç”³':'é‡‘','é…‰':'é‡‘','å£¬':'æ°´','ç™¸':'æ°´','äº¥':'æ°´','å­':'æ°´' };
        const SHI_SHEN_RELATION = { 'æ¯”è‚©':['ç”²ç”²','ä¹™ä¹™','ä¸™ä¸™','ä¸ä¸','æˆŠæˆŠ','å·±å·±','åºšåºš','è¾›è¾›','å£¬å£¬','ç™¸ç™¸'], 'åŠ«è²¡':['ç”²ä¹™','ä¹™ç”²','ä¸™ä¸','ä¸ä¸™','æˆŠå·±','å·±æˆŠ','åºšè¾›','è¾›åºš','å£¬ç™¸','ç™¸å£¬'], 'é£Ÿç¥':['ç”²ä¸™','ä¹™ä¸','ä¸™æˆŠ','ä¸å·±','æˆŠåºš','å·±è¾›','åºšå£¬','è¾›ç™¸','å£¬ç”²','ç™¸ä¹™'], 'å‚·å®˜':['ç”²ä¸','ä¹™ä¸™','ä¸™å·±','ä¸æˆŠ','æˆŠè¾›','å·±åºš','åºšç™¸','è¾›å£¬','å£¬ä¹™','ç™¸ç”²'], 'åè²¡':['ç”²æˆŠ','ä¹™å·±','ä¸™åºš','ä¸è¾›','æˆŠå£¬','å·±ç™¸','åºšç”²','è¾›ä¹™','å£¬ä¸™','ç™¸ä¸'], 'æ­£è²¡':['ç”²å·±','ä¹™æˆŠ','ä¸™è¾›','ä¸åºš','æˆŠç™¸','å·±å£¬','åºšä¹™','è¾›ç”²','å£¬ä¸','ç™¸ä¸™'], 'ä¸ƒæ®º':['ç”²åºš','ä¹™è¾›','ä¸™å£¬','ä¸ç™¸','æˆŠç”²','å·±ä¹™','åºšä¸™','è¾›ä¸','å£¬æˆŠ','ç™¸å·±'], 'æ­£å®˜':['ç”²è¾›','ä¹™åºš','ä¸™ç™¸','ä¸å£¬','æˆŠä¹™','å·±ç”²','åºšä¸','è¾›ä¸™','å£¬å·±','ç™¸æˆŠ'], 'åå°':['ç”²å£¬','ä¹™ç™¸','ä¸™ç”²','ä¸ä¹™','æˆŠä¸™','å·±ä¸','åºšæˆŠ','è¾›å·±','å£¬åºš','ç™¸è¾›'], 'æ­£å°':['ç”²ç™¸','ä¹™å£¬','ä¸™ä¹™','ä¸ç”²','æˆŠä¸','å·±ä¸™','åºšå·±','è¾›åºš','å£¬è¾›','ç™¸åºš'] };

        let currentResult = null;

        function getShiShen(dayGan, targetGan) {
            const pair = dayGan + targetGan;
            for (let key in SHI_SHEN_RELATION) {
                if (SHI_SHEN_RELATION[key].includes(pair)) return key;
            }
            return "--";
        }

        function calculateBazi() {
            if (typeof Solar === 'undefined') {
                alert("è¨ˆç®—çµ„ä»¶è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™ 3 ç§’å¾Œå†è©¦ã€‚å¦‚æœæŒçºŒå¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯é€£ç·šã€‚");
                return;
            }

            const dateInput = document.getElementById('date').value;
            const timeInput = document.getElementById('time').value;
            if (!dateInput) return alert("è«‹é¸æ“‡å‡ºç”Ÿæ—¥æœŸ");

            try {
                const [y, m, d] = dateInput.split('-').map(Number);
                const [hh, mm] = timeInput.split(':').map(Number);
                const solar = Solar.fromYmdHms(y, m, d, hh, mm, 0);
                const eightChar = solar.getLunar().getEightChar();
                
                const dG = eightChar.getDayGan();
                const pillars = {
                    yP: eightChar.getYear(),
                    mP: eightChar.getMonth(),
                    dP: eightChar.getDay(),
                    hP: eightChar.getTime(),
                    yS: getShiShen(dG, eightChar.getYearGan()),
                    mS: getShiShen(dG, eightChar.getMonthGan()),
                    hS: getShiShen(dG, eightChar.getTimeGan())
                };

                // æ›´æ–°ä»‹é¢
                document.getElementById('yP').innerText = pillars.yP;
                document.getElementById('mP').innerText = pillars.mP;
                document.getElementById('dP').innerText = pillars.dP;
                document.getElementById('hP').innerText = pillars.hP;
                document.getElementById('yS').innerText = pillars.yS;
                document.getElementById('mS').innerText = pillars.mS;
                document.getElementById('hS').innerText = pillars.hS;

                // äº”è¡Œä½”æ¯”
                const allChars = (pillars.yP + pillars.mP + pillars.dP + pillars.hP).split('');
                let counts = { 'æœ¨':0, 'ç«':0, 'åœŸ':0, 'é‡‘':0, 'æ°´':0 };
                allChars.forEach(c => { if(FIVE_ELEMENTS[c]) counts[FIVE_ELEMENTS[c]]++; });
                
                let barHtml = '', energyText = '';
                const colors = { 'æœ¨': 'bg-emerald-500', 'ç«': 'bg-rose-500', 'åœŸ': 'bg-amber-600', 'é‡‘': 'bg-slate-400', 'æ°´': 'bg-blue-500' };
                for(let k in counts) {
                    const pct = Math.round((counts[k]/8)*100);
                    barHtml += `<div class="flex items-center gap-2 text-[10px]"><span class="w-4 font-bold">${k}</span><div class="flex-1 bg-white h-1.5 rounded-full overflow-hidden border"><div class="${colors[k]} h-full" style="width:${pct}%"></div></div><span>${pct}%</span></div>`;
                    energyText += `${k}${pct}% `;
                }
                document.getElementById('elementBars').innerHTML = barHtml;
                document.getElementById('elementArea').classList.remove('hidden');

                currentResult = {
                    pillars: `${pillars.hP} ${pillars.dP} ${pillars.mP} ${pillars.yP}`,
                    shishen: `${pillars.hS} | æ—¥ä¸» | ${pillars.mS} | ${pillars.yS}`,
                    energy: energyText,
                    dayElement: FIVE_ELEMENTS[dG]
                };
            } catch (err) {
                alert("è¨ˆç®—ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
            }
        }

        function saveToHistory() {
            if (!currentResult) return alert("è«‹å…ˆé€²è¡Œæ’ç›¤");
            const name = document.getElementById('name').value || "æœªå";
            const gender = document.getElementById('gender').value;
            const date = document.getElementById('date').value;
            const style = { 'æœ¨':'bg-wood', 'ç«':'bg-fire', 'åœŸ':'bg-earth', 'é‡‘':'bg-metal', 'æ°´':'bg-water' }[currentResult.dayElement];
            
            const text = `ã€å‘½ä¾‹ç´€éŒ„ã€‘\nå§“åï¼š${name} (${gender})\nå…«å­—ï¼š${currentResult.pillars}\nä¸»æ˜Ÿï¼š${currentResult.shishen}\nèƒ½é‡ï¼š${currentResult.energy}\n--------------------\næ—¥æœŸï¼š${date}`;
            
            const history = JSON.parse(localStorage.getItem('bazi_v12') || '[]');
            history.unshift({ id: Date.now(), text, name, style });
            localStorage.setItem('bazi_v12', JSON.stringify(history));
            renderHistory();
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('bazi_v12') || '[]');
            document.getElementById('historyList').innerHTML = history.map(item => `
                <div class="${item.style} p-4 rounded-2xl border mb-3 shadow-sm">
                    <div class="flex justify-between text-xs font-bold mb-2"><span>${item.name}</span><button onclick="deleteItem(${item.id})" class="text-slate-400">åˆªé™¤</button></div>
                    <pre class="text-[11px] font-mono bg-white/70 p-3 rounded-xl overflow-x-auto text-slate-600">${item.text}</pre>
                    <button onclick="copyText(\`${item.text.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)" class="w-full mt-2 py-3 bg-white/90 text-indigo-600 rounded-xl text-xs font-black">ä¸€éµè¤‡è£½</button>
                </div>
            `).join('');
        }

        function copyText(t) { navigator.clipboard.writeText(t); alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"); }
        function deleteItem(id) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { let h = JSON.parse(localStorage.getItem('bazi_v12') || '[]'); localStorage.setItem('bazi_v12', JSON.stringify(h.filter(i => i.id !== id))); renderHistory(); } }
        
        window.onload = renderHistory;
    </script>
</body>
</html>
